# List available recipes
default:
    @just --list

# Check required environment variables
check-env:
    @if [ -z "${DB_USERNAME:-}" ]; then \
        echo "Error: DB_USERNAME environment variable is not set"; \
        echo "Please source your .env file: source .env"; \
        exit 1; \
    fi
    @if [ -z "${DB_PASSWORD:-}" ]; then \
        echo "Error: DB_PASSWORD environment variable is not set"; \
        echo "Please source your .env file: source .env"; \
        exit 1; \
    fi

# Start MongoDB, wait for it to be ready, and seed sample data
db: check-env
    docker compose up -d mongodb
    @echo "Waiting for MongoDB to accept connections..."
    @until docker compose exec mongodb mongosh --quiet \
        -u "${DB_USERNAME}" -p "${DB_PASSWORD}" \
        --eval "db.runCommand({ ping: 1 })" > /dev/null 2>&1; do \
        sleep 1; \
    done
    @echo "MongoDB is ready. Seeding data..."
    uv run python -m backend.seed

# Start MongoDB (with seed) then run the backend
dev: db
    @echo "Starting backend..."
    uv run backend

# Stop MongoDB
db-stop:
    docker compose down

# View MongoDB logs
db-logs:
    docker compose logs -f mongodb

# Restart everything
restart: db-stop dev

# Re-seed the database (drops existing data)
seed: check-env
    uv run seed
